name: Update README with HCP Terraform Info

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Derive workspace name from repo
        id: workspace
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          WORKSPACE_NAME=$(echo "$REPO_NAME" | sed 's/-dev$//' | sed 's/-prod$//')
          echo "name=$WORKSPACE_NAME" >> $GITHUB_OUTPUT
      
      - name: Fetch HCP Terraform info
        id: tfc
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          ORG="ghdemo"
          WS_NAME="${{ steps.workspace.outputs.name }}"
          
          WS_DATA=$(curl -s -H "Authorization: Bearer $TFC_TOKEN" \
            "https://app.terraform.io/api/v2/organizations/$ORG/workspaces/$WS_NAME")
          
          WS_ID=$(echo "$WS_DATA" | jq -r '.data.id')
          CREATED=$(echo "$WS_DATA" | jq -r '.data.attributes."created-at"')
          
          RUN_DATA=$(curl -s -H "Authorization: Bearer $TFC_TOKEN" \
            "https://app.terraform.io/api/v2/workspaces/$WS_ID/runs?page%5Bsize%5D=1")
          
          RUN_ID=$(echo "$RUN_DATA" | jq -r '.data[0].id')
          RUN_STATUS=$(echo "$RUN_DATA" | jq -r '.data[0].attributes.status')
          
          echo "ws_id=$WS_ID" >> $GITHUB_OUTPUT
          echo "ws_created=$CREATED" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_status=$RUN_STATUS" >> $GITHUB_OUTPUT
      
      - name: Generate and commit README
        run: |
          cat > README.md << EOF
          # ${{ github.event.repository.name }}
          
          Provisioned by **HCP Terraform** via No-Code workflow.
          
          | Property | Value |
          |----------|-------|
          | Workspace | [${{ steps.workspace.outputs.name }}](https://app.terraform.io/app/ghdemo/workspaces/${{ steps.workspace.outputs.name }}) |
          | Run | [${{ steps.tfc.outputs.run_id }}](https://app.terraform.io/app/ghdemo/workspaces/${{ steps.workspace.outputs.name }}/runs/${{ steps.tfc.outputs.run_id }}) |
          | Status | ${{ steps.tfc.outputs.run_status }} |
          EOF
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: update README with HCP Terraform info"
          git push
