name: Update README with HCP Terraform Info

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.repository.name, 'template') }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Derive workspace name from repo
        id: workspace
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          WORKSPACE_NAME=$(echo "$REPO_NAME" | sed 's/-dev$//' | sed 's/-prod$//')
          echo "name=$WORKSPACE_NAME" >> $GITHUB_OUTPUT
          echo "Derived workspace: $WORKSPACE_NAME"
      
      - name: Wait for TFC_TOKEN secret and fetch info
        id: tfc
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          ORG="ghdemo"
          WS_NAME="${{ steps.workspace.outputs.name }}"
          
          for attempt in {1..24}; do
            echo "Attempt $attempt of 24..."
            
            if [ -z "$TFC_TOKEN" ]; then
              echo "TFC_TOKEN not available yet, waiting..."
              sleep 10
              continue
            fi
            
            echo "Fetching workspace: $WS_NAME"
            WS_DATA=$(curl -s \
              -H "Authorization: Bearer $TFC_TOKEN" \
              "https://app.terraform.io/api/v2/organizations/$ORG/workspaces/$WS_NAME")
            
            WS_ID=$(echo "$WS_DATA" | jq -r '.data.id // empty')
            
            if [ -z "$WS_ID" ]; then
              echo "Workspace not found yet, waiting..."
              sleep 10
              continue
            fi
            
            CREATED=$(echo "$WS_DATA" | jq -r '.data.attributes."created-at"')
            echo "Workspace ID: $WS_ID"
            
            echo "Fetching runs for workspace: $WS_ID"
            RUN_DATA=$(curl -s \
              -H "Authorization: Bearer $TFC_TOKEN" \
              "https://app.terraform.io/api/v2/workspaces/$WS_ID/runs?page%5Bsize%5D=1")
            
            RUN_ID=$(echo "$RUN_DATA" | jq -r '.data[0].id // empty')
            RUN_STATUS=$(echo "$RUN_DATA" | jq -r '.data[0].attributes.status // empty')
            
            if [ -z "$RUN_ID" ]; then
              echo "No runs found yet, waiting..."
              sleep 10
              continue
            fi
            
            echo "Run ID: $RUN_ID, Status: $RUN_STATUS"
            
            echo "ws_id=$WS_ID" >> $GITHUB_OUTPUT
            echo "ws_created=$CREATED" >> $GITHUB_OUTPUT
            echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
            echo "run_status=$RUN_STATUS" >> $GITHUB_OUTPUT
            exit 0
          done
          
          echo "Failed to fetch HCP Terraform info after 4 minutes"
          exit 1
      
      - name: Generate README
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          WS_NAME: ${{ steps.workspace.outputs.name }}
          WS_ID: ${{ steps.tfc.outputs.ws_id }}
          WS_CREATED: ${{ steps.tfc.outputs.ws_created }}
          RUN_ID: ${{ steps.tfc.outputs.run_id }}
          RUN_STATUS: ${{ steps.tfc.outputs.run_status }}
        run: |
          cat > README.md << EOF
          # ${REPO_NAME}

          This repository was provisioned by **HCP Terraform** using the No-Code workflow.

          ## Provisioning Details

          | Property | Value |
          |----------|-------|
          | **Workspace** | [${WS_NAME}](https://app.terraform.io/app/ghdemo/workspaces/${WS_NAME}) |
          | **Workspace ID** | \`${WS_ID}\` |
          | **Created** | ${WS_CREATED} |
          | **Run ID** | \`${RUN_ID}\` |
          | **Run Status** | ${RUN_STATUS} |

          ## Links

          - [HCP Terraform Workspace](https://app.terraform.io/app/ghdemo/workspaces/${WS_NAME})
          - [Provisioning Run](https://app.terraform.io/app/ghdemo/workspaces/${WS_NAME}/runs/${RUN_ID})
          EOF
      
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: update README with HCP Terraform info"
          git push
